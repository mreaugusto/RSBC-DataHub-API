import Vue from 'vue'
import Vuex from 'vuex'
import App from './App.vue'
import { BootstrapVue, BootstrapVueIcons, ModalPlugin } from 'bootstrap-vue'
import { ValidationProvider } from 'vee-validate';
import VueKeyCloak from '@dsb-norge/vue-keycloak-js'
import router from '@/router'
import VueMask from 'v-mask'


import "@/config/custom_stylesheet.scss";
import {rsiStore} from "@/store/store.js"

import './registerServiceWorker'
import constants from "@/config/constants";


Vue.use(Vuex)

// Make BootstrapVue components throughout your project
Vue.use(BootstrapVue)
Vue.use(ModalPlugin)
Vue.use(BootstrapVueIcons)
Vue.use(VueMask);


// import custom validation rules
require("@/helpers/validators");
Vue.component('ValidationProvider', ValidationProvider);

Vue.config.productionTip = false


Vue.use(VueKeyCloak, {
  init: {
    onLoad: 'check-sso',
    pkceMethod: "S256",
  },
  config: constants.API_ROOT_URL + '/api/v1/static/keycloak',
  onReady: () => {
      rsiStore.commit("setKeycloak", Vue.prototype.$keycloak)

      new Vue({
          router,
          store: rsiStore,
          async created() {
            // get all forms from indexdb database and save it to state
            await rsiStore.dispatch("getAllFormsFromDB")
                .then( () => {
                    // if the user has been working offline, and has used up some of ids, need to get more ids to top up to state
                    rsiStore.dispatch("getMoreFormsFromApiIfNecessary")
                });
            // tables like lot operator, cities, vehicles make and model; get from api and save to state
            await rsiStore.dispatch("downloadLookupTables");

          },
          render: h => h(App),
        }).$mount('#app')
  },

  // if the user is offline, get the forms for the user from the indexeddb
  onInitError: () => {
      new Vue({
          router,
          store: rsiStore,
          async created() {

            await rsiStore.dispatch("getAllFormsFromDB");
            // download lookup tables from service worker
            await rsiStore.dispatch("downloadLookupTables")

          },
          render: h => h(App),
        }).$mount('#app')
  }
});


rsiStore.subscribe((mutation) => {
      if (mutation.type === 'setKeycloak') {
        rsiStore.dispatch("fetchStaticLookupTables", {"resource": "user_roles", "admin": false, "static": false})
            .then(data => {
                rsiStore.dispatch("updateUserIsAuthenticated", data)
            })
        rsiStore.dispatch("fetchStaticLookupTables", {"resource": "users", "admin": false, "static": false})
      }
      if (mutation.type === 'updateFormField' ||
          mutation.type === 'updateFormAttribute' ||
          mutation.type === 'updateCheckBox' ||
          mutation.type === 'populateDriverFromICBC' ||
          mutation.type === 'populateVehicleFromICBC' ||
          mutation.type === 'typeAheadUpdate' ||
          mutation.type === 'deleteFormField'
      ) {
        rsiStore.dispatch("saveCurrentFormToDB", rsiStore.state.currently_editing_form_object)
      }
    });




